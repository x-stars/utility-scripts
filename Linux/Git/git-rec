#!/bin/sh

EXTMSG="exit with code %d"
test ! -t 1 && FHEAD=">>> %s <<<\n" ||
    FHEAD=">>> \e[35m%s\e[0m <<<\n"
test ! -t 2 && FSTAT="!!! $EXTMSG !!!\n" ||
    FSTAT="!!! \e[33m$EXTMSG\e[0m !!!\n"

PIPE=/tmp/fgit-$$.pipe
test -p $PIPE || mkfifo $PIPE
find . -name .git > $PIPE &

ERRORS=0
while read -r DGIT; do
    REPO=`dirname "$DGIT" |
          sed 's,./,,'`
    cd -- "$REPO"
    printf "$FHEAD" "$REPO"
    git "$@" ; CODE=$?
    if [ $CODE -ne 0 ]; then
        ERRORS=$(($ERRORS + 1))
        printf "$FSTAT" $CODE >&2
    fi
    printf "\n"
    cd -> /dev/null
done < $PIPE

test -p $PIPE && rm -f $PIPE
exit $ERRORS
